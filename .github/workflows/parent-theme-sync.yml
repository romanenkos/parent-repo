name: Parent Theme Code Synchronization

on:
  push:
    branches:
      - main 

jobs:
  sync_to_child_themes:
    runs-on: ubuntu-latest
    permissions:
      contents: write 
      pull-requests: write # Required for creating PRs on conflict
      
    steps:
      - name: Checkout Repository (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          token: ${{ secrets.GITHUB_TOKEN }} 
          
      - name: Configure Git User and Branches
        id: config
        run: |
          git config user.name "GitHub Actions Sync"
          git config user.email "actions@github.com"
          echo "PARENT_BRANCH=main" >> $GITHUB_ENV
          echo "CHILD_THEMES=child-amer-main child-emea-main child-anz-main" >> $GITHUB_ENV

      # --- PHASE 1: CONFLICT CHECK ON ALL BRANCHES ---
      - name: 1. All-or-Nothing Conflict Check
        id: conflict_check
        env:
          CHILD_THEMES: ${{ env.CHILD_THEMES }}
          PARENT_BRANCH: ${{ env.PARENT_BRANCH }}
        
        run: |
          FAILED_BRANCHES="" 
          MAIN_DIR=$(pwd)
          
          for CHILD_BRANCH in $CHILD_THEMES; do
            WORKTREE_DIR="${MAIN_DIR}/worktree-${CHILD_BRANCH}"
            echo "--- Checking conflicts for: $CHILD_BRANCH ---"
            
            # Create worktree
            git worktree add --force $WORKTREE_DIR $CHILD_BRANCH
            cd $WORKTREE_DIR
            
            # Attempt Merge (Non-Fast-Forward, No Commit)
            if ! git merge --no-ff --no-commit $PARENT_BRANCH > /dev/null 2>&1; then
              echo "âŒ FATAL: Git merge failed unexpectedly. Flagging for failure."
              git merge --abort
              FAILED_BRANCHES="$FAILED_BRANCHES $CHILD_BRANCH"
            
            # Conflict Detection
            elif git status --porcelain | grep -E '^(UU|AA|DD)'; then
              echo "ðŸš¨ CONFLICT DETECTED. Flagging branch for PR creation."
              FAILED_BRANCHES="$FAILED_BRANCHES $CHILD_BRANCH"
              git merge --abort
            else
              echo "âœ… No conflicts detected."
            fi
            
            # Cleanup worktree
            cd $MAIN_DIR
            git worktree remove $WORKTREE_DIR --force
            echo "--- Check complete for $CHILD_BRANCH ---"
          done
          
          # Set outputs for the next steps
          echo "failed_branches=${FAILED_BRANCHES}" >> $GITHUB_OUTPUT
          
          if [ -n "$FAILED_BRANCHES" ]; then
            echo "::error::Conflict check failed on one or more branches. HALTING DEPLOYMENT."
            exit 1 # Fail the step to trigger the conflict handler (Phase 3)
          fi
          
          echo "ðŸŽ‰ All branches are conflict-free. Proceeding to final merge."


      # --- PHASE 2: SUCCESSFUL MERGE AND PUSH (Only runs if check passed) ---
      - name: 2. Final All-Clear Merge and Deployment
        if: success()
        env:
          CHILD_THEMES: ${{ env.CHILD_THEMES }}
          PARENT_BRANCH: ${{ env.PARENT_BRANCH }}
          
        run: |
          # Revert to the main directory for standard checkout/push operations
          # NOTE: Since no worktrees were left behind, the environment is clean.
          
          for CHILD_BRANCH in $CHILD_THEMES; do
            echo "--- Final Merge and Push: $CHILD_BRANCH ---"
            
            # Checkout the target child branch in the main working directory
            git checkout $CHILD_BRANCH
            
            # Perform the final merge and commit
            git merge --no-ff $PARENT_BRANCH -m "Automated Sync: Merge stable code from $PARENT_BRANCH (SHA: $(git rev-parse --short $PARENT_BRANCH))"
            
            # Push the merged code back (Triggers Shopify deployment)
            git push origin $CHILD_BRANCH
            
            echo "ðŸš€ Successfully deployed to $CHILD_BRANCH."
          done
          
          # Return to a neutral branch after push
          git checkout $PARENT_BRANCH